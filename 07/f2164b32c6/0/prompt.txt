Implement the following plan:

# Fix: Recipe images appear black-and-white after reload

## Context

After adding a recipe, its image displays in color (the original URI is still in React state). Background processing then runs, and the geometry/dewarp phase **unconditionally converts the image to grayscale** before remapping. This grayscale result flows through the rest of the pipeline and overwrites the original color photo on disk. On next app launch, images load from disk and appear B&W.

## Root Cause

`lib/photo-processor/pipelines/geometry/dewarp-pipeline.ts`, function `applyRemapAndThreshold` (lines 141-175):

Grayscale conversion and remapping are coupled in a single function. The grayscale conversion happens unconditionally, even when `noBinary: true` (the recipe default). Color information is permanently lost before the remap step.

## Fix

Split `applyRemapAndThreshold` into two independent functions in `dewarp-pipeline.ts`:

**`applyRemap`** â€” always called, operates on the color BGR image:
```typescript
function applyRemap(
  cv: CV,
  img: CVMat,
  mapX: CVMat,
  mapY: CVMat
): CVMat {
  const remapped = new cv.Mat();
  cv.remap(img, remapped, mapX, mapY, cv.INTER_CUBIC, cv.BORDER_REPLICATE);
  return remapped;
}
```

**`applyThreshold`** â€” called only when `noBinary: false`, converts to grayscale and binarizes:
```typescript
function applyThreshold(
  cv: CV,
  img: CVMat
): CVMat {
  const imgGray = new cv.Mat();
  cv.cvtColor(img, imgGray, cv.COLOR_RGB2GRAY);

  const thresh = new cv.Mat();
  cv.adaptiveThreshold(
    imgGray, thresh, 255,
    cv.ADAPTIVE_THRESH_MEAN_C, cv.THRESH_BINARY,
    Config.ADAPTIVE_WINSZ, 25
  );
  imgGray.delete();
  return thresh;
}
```

**Update the call site** in `threshold()` (line 438-444):
```typescript
// Before:
const result = applyRemapAndThreshold(cv, img, mapX, mapY, noBinary);

// After:
const remapped = applyRemap(cv, img, mapX, mapY);
let result: CVMat;
if (noBinary) {
  result = remapped;
} else {
  result = applyThreshold(cv, remapped);
  remapped.delete();
}
```

**Resulting pipeline after fix:**
1. Geometry: color BGR in -> `applyRemap` -> color dewarped out (always)
2. Geometry: if `!noBinary` -> `applyThreshold` -> binary B&W (conditional)
3. Lighting: receives color -> `coloredUri` (display) + `grayscaleUri` (OCR)
4. Clarity: enhances both independently
5. Save: color image preserved on disk
6. OCR: uses grayscale (never touches disk)

## Files Modified

- `lib/photo-processor/pipelines/geometry/dewarp-pipeline.ts` â€” replace `applyRemapAndThreshold` with `applyRemap` + `applyThreshold`, update call site in `threshold()`

## Verification

1. Add a new recipe with a color photo
2. Wait for background processing to complete
3. Close and reopen the app
4. Confirm the image remains in color after reload


If you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /Users/eryk.napierala/.REDACTED.jsonl

---

Stop hook feedback:
ðŸ“‹ **Self-Review**

Please review these aspects of your changes:

**Implementation Completeness:**
â€¢ Does the implementation actually do what it claims, or just return hardcoded values?

**Code Quality:**
â€¢ Is there duplicated logic that should be extracted?

**Integration & Refactoring:**
â€¢ Did you leave any temporary workarounds or hacks?

**Codebase Consistency:**
â€¢ Did you update all the places that depend on what you changed?

ðŸ’¡ **Tip:** The code-review-expert subagent is available. Use it to review each self-review topic.
Use the Task tool with subagent_type: "code-review-expert"

Address any concerns before proceeding.