#!/usr/bin/env node

/**
 * Build script for OpenCV WebView Bridge using Metro
 * Bundles the TypeScript bridge file with all dependencies using Metro bundler
 * that can be inlined into the WebView HTML.
 */

const Metro = require("metro");
const path = require("path");
const fs = require("fs");

const projectRoot = path.join(__dirname, "..");
const inputFile = path.join(
  projectRoot,
  "lib/photo-processor/opencv-webview-bridge.ts"
);
const outputFile = path.join(
  projectRoot,
  "lib/photo-processor/opencv-webview-bridge.bundle.js"
);

async function build() {
  try {
    console.log("üî® Building OpenCV WebView bridge with Metro...");

    // Load Metro config
    const config = await Metro.loadConfig({
      cwd: projectRoot,
      config: path.join(projectRoot, "metro.config.js"),
    });

    // Build the bundle
    await Metro.runBuild(config, {
      entry: inputFile,
      out: outputFile,
      platform: "native", // Use web platform for browser-compatible output
      minify: false, // Keep readable for debugging
      dev: true,
      sourceMap: true,
    });

    // Add a banner to the output
    const banner = `/**
 * OpenCV WebView Bridge - Bundled by Metro
 * This file is auto-generated by scripts/build-opencv-bridge.js
 * DO NOT EDIT MANUALLY - Edit opencv-webview-bridge.ts instead
 * Generated: ${new Date().toISOString()}
 */
`;

    const bundledCode = fs.readFileSync(outputFile, "utf8");
    fs.writeFileSync(outputFile, banner + bundledCode, "utf8");

    const stats = fs.statSync(outputFile);
    console.log(
      `‚úÖ Bridge built successfully: ${outputFile} (${Math.round(
        stats.size / 1024
      )}KB)`
    );
  } catch (error) {
    console.error("‚ùå Build failed:", error);
    process.exit(1);
  }
}

build();
