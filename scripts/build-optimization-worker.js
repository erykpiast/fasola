#!/usr/bin/env node

/**
 * Build script for Optimization Web Worker using Metro
 * Bundles the TypeScript worker file with all dependencies using Metro bundler
 * that can be loaded as a Blob URL in the browser.
 */

const Metro = require("metro");
const path = require("path");
const fs = require("fs");

const projectRoot = path.join(__dirname, "..");
const inputFile = path.join(
  projectRoot,
  "lib/photo-processor/optimization.worker.ts"
);
const outputFile = path.join(
  projectRoot,
  "lib/photo-processor/optimization.worker.bundle.js"
);

async function build() {
  try {
    console.log("üî® Building Optimization Web Worker with Metro...");

    // Load Metro config
    const config = await Metro.loadConfig({
      cwd: projectRoot,
      config: path.join(projectRoot, "metro.config.js"),
    });

    // Build the bundle
    await Metro.runBuild(config, {
      entry: inputFile,
      out: outputFile,
      platform: "web",
      minify: false,
      dev: true,
      sourceMap: true,
    });

    // Add a banner to the output
    const banner = `/**
 * Optimization Web Worker - Bundled by Metro
 * This file is auto-generated by scripts/build-optimization-worker.js
 * DO NOT EDIT MANUALLY - Edit optimization.worker.ts instead
 * Generated: ${new Date().toISOString()}
 */
`;

    const bundledCode = fs.readFileSync(outputFile, "utf8");
    fs.writeFileSync(outputFile, banner + bundledCode, "utf8");

    const stats = fs.statSync(outputFile);
    console.log(
      `‚úÖ Worker built successfully: ${outputFile} (${Math.round(
        stats.size / 1024
      )}KB)`
    );
  } catch (error) {
    console.error("‚ùå Build failed:", error);
    process.exit(1);
  }
}

build();

